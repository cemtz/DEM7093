---
title: "DEM 5093/7093 Lab 2 using R - Map projections and transformations"
author: "Corey Sparks, Ph.D."
date: "2/13/2020"
output:
   html_document:
    df_print: paged
    fig_height: 7
    fig_width: 7
    toc: yes
    includes:
      in_header: logo.html
---

This lab complements the [exercise using Qgis for today ](https://docs.google.com/document/d/e/2PACX-1vQVSD4MKW4rTSQaNlM1cOULh-0-rSpoAaU3N_Xe7elujIj-ELgWTIGVDygF8qKl3QVBtpxPSi7YuDOS/pub)

Here, we use tidycensus to read some tract data, learn its projection information, transform it to a new coordinate system and measure some distance between features. 


```{r}
library(tidycensus)
library(sf)
library(dplyr)
```

### Read in Bexar county tracts

```{r, results="hide"}
sa_acs<-get_acs(geography = "tract",
                state="TX",
                county = c("Bexar"),
                year = 2017,
                variables=c( "DP05_0001E", 
                            "DP03_0119PE") ,
                geometry = T, output = "wide")

#create a county FIPS code - 5 digit
sa_acs$county<-substr(sa_acs$GEOID, 1, 5)

#rename variables and filter missing cases
sa_acs2<-sa_acs%>%
  mutate(totpop= DP05_0001E, ppov=DP03_0119PE) %>%
#  st_transform(crs = 102740)%>%
  na.omit()


```

### find coordinate system of current map
```{r}

st_crs(sa_acs2)
```



### create basic map
```{r}
ppov_map<-sa_acs2 %>%
  mutate(cpov=cut(ppov,breaks = quantile(ppov, na.rm=T, p=seq(0,1,length.out = 6)),include.lowest = T))

library(ggsn)

p1<-ggplot(ppov_map, aes(fill = cpov, color = cpov)) + 
  geom_sf() + 
  ggtitle("Proportion in poverty", 
          subtitle = "Bexar County Texas, 2017 - Quantile Breaks")+
    scale_fill_brewer(palette = "Reds") + 
  scale_color_brewer(palette = "Reds")+
  theme(axis.text.x = element_blank(), axis.text.y = element_blank())+
  north(ppov_map)+
  scalebar(ppov_map, location="bottomleft", dist=5, transform = T,dist_unit = "km",  model="WGS84", st.size =2 )
p1


```


### re-project map into South Central Texas projection

```{r}
new_sa<-st_transform(sa_acs2, crs = 2278)

#Extract two tracts
twtr<-new_sa%>%
  filter(GEOID %in% c(48029181820, 48029110600))

# get centroid coordinates for two tracts
tr_co<-st_centroid(twtr)

#Measure feet apart
st_distance(tr_co)
```


# This part doesn't work yet
```{r, eval = FALSE}
library(RQGIS3)

menv<-set_env()

#open_app()

find_algorithms(search_term="d
                istance", name_only=T)
get_usage(alg = "qgis:distancematrix")
params = get_args_man(alg = "native:centroids")
params

out = run_qgis(alg = "qgis:distancematrix",
               INPUT = tr_co[, 1],
               INPUT_FIELD = tr_co$GEOID,
               TARGET = tr_co,
               TARGET_FIELD = tr_co$GEOID,
               MATRIX_TYPE = 0, 
               NEAREST_POINTS = 1,
              load_output = TRUE, qgis_env = menv)

```